# This is a basic workflow that is manually triggered

name: Push update

on:
  workflow_dispatch:
    inputs:
      loader_ver:
        description: 'Loader version'
        default: ''
      api_ver:
        description: 'API version'
        default: ''
      cli_ver:
        description: 'CLI version'
        default: ''

jobs:
  push:
    runs-on: ubuntu-latest

    steps:

      - uses: actions/checkout@v2
        with:
          repository: geode-sdk/suite
          path: suite
          ref: nightly
          submodules: recursive
          token: '${{ secrets.GEODE_BOT_PUSH_BIN_TOKEN }}'

      - id: json
        run: |
          ls ${{ github.workspace }}
          content=`cat ${{ github.workspace }}/versions.json`
          echo "::set-output name=json::$content"
      - id: versions
        run: |
          echo "::set-output loader=${{github.event.inputs.loader_ver != '' && github.event.inputs.loader_ver || fromJson(steps.json.outputs.json).loader}}"
          echo "::set-output api=${{github.event.inputs.api_ver != '' && github.event.inputs.api_ver || fromJson(steps.json.outputs.json).api}}"
          echo "::set-output cli=${{github.event.inputs.cli_ver != '' && github.event.inputs.cli_ver || fromJson(steps.json.outputs.json).cli}}"

      - name: Update version info
        run: |
          echo ${{toJSON(steps.versions.outputs)}} > ${{ github.workspace }}/versions.json

      - name: Commit, push to suite, and merge
        working-directory: ${{ github.workspace }}/suite
        run: |
          git config --local user.email "${{ secrets.GEODE_BOT_EMAIL }}"
          git config --local user.name "GeodeBot"
          git add -A
          git commit -m "Stable update push"
          git push "https://GeodeBot:${{ secrets.GEODE_BOT_PUSH_BIN_TOKEN}}@github.com/geode-sdk/suite.git"
          git checkout main
          git merge nightly
          git commit -m "Loader: ${{steps.versions.outputs.loader}} API: ${{steps.versions.outputs.api}} CLI: ${{steps.versions.outputs.cli}}"
          git push "https://GeodeBot:${{ secrets.GEODE_BOT_PUSH_BIN_TOKEN}}@github.com/geode-sdk/suite.git"
